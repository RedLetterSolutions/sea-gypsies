@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@implements IDisposable

@if (IsOpen)
{
  <div class="cf-overlay" @onclick="HandleOverlayClick">
    <div class="cf-container" @onclick:stopPropagation="true">
      <button class="cf-close" @onclick="OnCancel" aria-label="Close">
        <img src="/button_icon.png" alt="" />
      </button>

      <div class="cf-content">
        <h1 class="cf-title">CONTACT US</h1>
        <p class="cf-subtitle">We'd love to hear from you:</p>

        <form data-rls-contact="sea_gypsies" data-rls-redirect="false" id="contactUsForm" data-rls-on-success="handleContactSuccess" data-rls-on-error="handleContactError">
          <!-- Honeypot (spam protection) -->
          <input type="text" name="_hp" style="display:none;" tabindex="-1" autocomplete="off">

          <div class="cf-form">
            <div class="cf-field">
              <label class="cf-label">
                <span class="cf-label-text">NAME</span>
              </label>
              <input class="cf-input" type="text" placeholder="ENTER YOUR NAME"
                     name="name" autocomplete="name" required>
            </div>

            <div class="cf-field">
              <label class="cf-label">
                <span class="cf-label-text">EMAIL ADDRESS</span>
              </label>
              <input class="cf-input" type="email" placeholder="ENTER EMAIL ADDRESS"
                     name="email" autocomplete="email" required>
            </div>

            <div class="cf-field">
              <label class="cf-label">
                <span class="cf-label-text">MESSAGE</span>
              </label>
              <textarea class="cf-input cf-textarea" placeholder="ENTER YOUR MESSAGE"
                        name="message" rows="5" required></textarea>
            </div>

            <div class="cf-button-row">
              <button type="submit" class="cf-btn cf-send" aria-label="Send Message">
                <img src="/button_icon.png" alt="" class="cf-btn-icon" />
                <span>SEND MESSAGE</span>
              </button>
              <button type="button" class="cf-btn cf-cancel" aria-label="Cancel" @onclick="OnCancel">
                CANCEL
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
}

@code {
  [Parameter] public bool IsOpen { get; set; }
  [Parameter] public EventCallback OnCancel { get; set; }
  [Inject] private NavigationManager Nav { get; set; } = default!;
  [Inject] private IJSRuntime JSRuntime { get; set; } = default!;
  private bool _initForOpen;
  private DotNetObjectReference<ContactForm>? _selfRef;

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender)
    {
      // Register this component instance so JS can close the modal on success
      _selfRef = DotNetObjectReference.Create(this);
      await JSRuntime.InvokeVoidAsync("setContactFormPageRef", _selfRef);
    }

    if (IsOpen && !_initForOpen)
    {
      try
      {
        await JSRuntime.InvokeVoidAsync("initContactUsForm");
        await JSRuntime.InvokeVoidAsync("bindRLSOnce");
        _initForOpen = true;
      }
      catch (Exception ex)
      {
        Console.WriteLine($"Error initializing form: {ex.Message}");
      }
    }
    else if (!IsOpen && _initForOpen)
    {
      _initForOpen = false; // reset for next open
    }
  }

  [JSInvokable]
  public void CloseContactFormFromJS()
  {
    OnCancel.InvokeAsync();
    StateHasChanged();
  }

  private async Task HandleOverlayClick()
  {
    await OnCancel.InvokeAsync();
  }

  public void Dispose()
  {
    _selfRef?.Dispose();
  }
}

<style>
  /* Fullscreen overlay with semi-transparent background */
  .cf-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: grid;
    place-items: center;
    z-index: 1000;
    backdrop-filter: blur(8px);
    /* Add safe margins so the form doesn't touch the top bar or bottom FAB on mobile */
    padding: calc(env(safe-area-inset-top) + 20px) 16px calc(env(safe-area-inset-bottom) + 28px) 16px;
  }

  /* Form container - recreating the cyan-bordered design */
  .cf-container {
    position: relative;
    width: clamp(600px, 50vw, 768px);
    background: rgba(0, 0, 0, 0.7);
    border: 3px solid #00d4ff;
    box-shadow:
      0 0 20px rgba(0, 212, 255, 0.4),
      inset 0 0 40px rgba(0, 212, 255, 0.05);
    padding: 0;
    font-family: 'apotek-comp', system-ui, -apple-system, sans-serif;
    /* Ensure the form never exceeds the viewport and can scroll internally on small devices */
    max-height: calc(100dvh - (env(safe-area-inset-top) + 20px) - (env(safe-area-inset-bottom) + 28px) - 32px);
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Close button - top right with custom icon */
  .cf-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: transparent;
    border: none;
    color: #00d4ff;
    cursor: pointer;
    z-index: 2;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .cf-close:hover {
    color: #00ffff;
    transform: scale(1.1);
  }

  .cf-close svg {
    width: 100%;
    height: 100%;
  }

  /* Content area with padding */
  .cf-content {
    padding: 60px 80px 50px 80px;
  }

  /* Title styling */
  .cf-title {
    font-family: 'apotek-comp', system-ui, -apple-system, sans-serif;
    font-size: clamp(32px, 3vw, 40px);
    font-weight: 100;
    letter-spacing: 15px;
    text-transform: uppercase;
    color: #ffffff;
    margin: 0 0 5px 0;
    text-align: left;
  }

  /* Subtitle */
  .cf-subtitle {
    font-family: 'apotek-comp', system-ui, -apple-system, sans-serif;
    font-size: clamp(16px, 1.5vw, 25px);
    font-weight: 300;
    letter-spacing: 3px;
    color: #00d4ff;
    margin: 0 0 40px 0;
    text-align: left;
  }

  /* Form layout */
  .cf-form {
    font-family: 'apotek-comp', system-ui, -apple-system, sans-serif;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  /* Field group */
  .cf-field {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* Label styling */
  .cf-label {
    font-family: 'apotek-comp', system-ui, -apple-system, sans-serif;
    font-size: clamp(10px, 1.5vw, 25px);
    font-weight: 300;
    letter-spacing: 10px;
    text-transform: uppercase;
    color: #ffffff;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .cf-label-text {
    font-family: 'apotek-comp', system-ui, -apple-system, sans-serif;
    color: #ffffff;
    letter-spacing: 10px;
    text-transform: uppercase;
  }

  /* Input field styling */
  .cf-input {
    width: 100%;
    background: rgba(0, 0, 0, 0.6);
    border: 2px solid #00d4ff;
    color: #00d4ff;
    font-family: 'apotek-comp', system-ui, -apple-system, sans-serif;
    font-size: clamp(15px, 1.4vw, 18px);
    font-weight: 300;
    letter-spacing: 3px;
    text-transform: uppercase;
    padding: 16px 20px;
    box-sizing: border-box;
    outline: none;
    transition: all 0.2s ease;
  }

  /* Textarea specific styling */
  .cf-textarea {
    resize: vertical;
    min-height: 120px;
    text-transform: none; /* Allow normal case for message */
  }

  .cf-input::placeholder {
    font-family: 'apotek-comp', system-ui, -apple-system, sans-serif;
    color: rgba(0, 212, 255, 0.5);
    font-weight: 300;
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  .cf-textarea::placeholder {
    text-transform: uppercase;
  }

  .cf-input:focus {
    background: rgba(0, 0, 0, 0.8);
    border-color: #00ffff;
    box-shadow: 
      0 0 10px rgba(0, 255, 255, 0.3),
      inset 0 0 10px rgba(0, 255, 255, 0.1);
  }

  /* Button row */
  .cf-button-row {
    display: flex;
    gap: 20px;
    margin-top: 16px;
  }

  /* Button base styles */
  .cf-btn {
    font-family: 'apotek-comp', system-ui, -apple-system, sans-serif;
    font-size: clamp(15px, 1.4vw, 17px);
    font-weight: 400;
    letter-spacing: 4px;
    text-transform: uppercase;
    padding: 14px 28px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    border: 2px solid;
  }

  /* Send button */
  .cf-send {
    background: #34818e;
    color: #ffffff;
    border-color: #00d4ff;
    font-weight: 300;
    letter-spacing: 8px;
    flex: 0 0 auto;
  }

  .cf-send:hover:not(:disabled) {
    background: #00ffff;
    border-color: #00ffff;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
    transform: translateY(-1px);
  }

  .cf-send:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .cf-btn-icon {
    width: 20px;
    height: 20px;
  }

  /* Cancel button */
  .cf-cancel {
    background: transparent;
    color: #12506e;
    border-color: #12506e;
    font-weight: 300;
    letter-spacing: 6px;
    margin-left: auto;
    flex: 0 0 auto;
  }

  .cf-cancel:hover {
    background: rgba(0, 212, 255, 0.1);
    border-color: #00ffff;
    color: #00ffff;
  }

  /* Responsive adjustments */
  @@media (max-width: 768px) {
    /* tighten overall layout and add a touch more outer padding on smaller screens */
    .cf-overlay {
      padding: calc(env(safe-area-inset-top) + 24px) 16px calc(env(safe-area-inset-bottom) + 36px) 16px;
    }

    .cf-container {
      /* leave a little more headroom/footroom on mid-size mobiles */
      max-height: calc(100dvh - (env(safe-area-inset-top) + 24px) - (env(safe-area-inset-bottom) + 36px) - 24px);
      width: 90vw;
      max-width: 560px;
    }

    .cf-content {
      padding: 24px 20px 16px 20px;
    }

    .cf-form { gap: 16px; }
    .cf-field { gap: 6px; }

    .cf-input { padding: 12px 16px; }

    .cf-button-row { margin-top: 8px; }

    .cf-btn { padding: 12px 18px; }

    .cf-subtitle { margin: 0 0 20px 0; }

    /* Reduce label letter-spacing ~50% on mobile/tablet */
    .cf-title { letter-spacing: 5px; }
    .cf-subtitle { letter-spacing: 2px; }
    .cf-label { letter-spacing: 5px; font-size: clamp(18px, 2vw, 25px); }
    .cf-label-text { letter-spacing: 5px; }
    .cf-send { letter-spacing: 4px; font-size: clamp(20px, 1.5vw, 30px); }

    .cf-button-row {
      flex-direction: column;
    }

    .cf-btn {
      width: 100%;
    }
  }

  @@media (max-width: 480px) {
    .cf-container {
      width: 90vw;
      max-width: 90vw;
      /* extra breathing room on very small screens */
      max-height: calc(100dvh - (env(safe-area-inset-top) + 28px) - (env(safe-area-inset-bottom) + 44px) - 16px);
    }

    .cf-content {
      padding: 20px 16px 14px 16px;
    }

    .cf-form { gap: 14px; }
    .cf-input { padding: 10px 14px; }
    .cf-btn { padding: 10px 16px; }
    .cf-button-row { gap: 12px; margin-top: 8px; }
    .cf-subtitle { margin: 0 0 16px 0; }

    /* Keep the reduced spacing on smaller phones as well */
    .cf-label { letter-spacing: 5px; }
    .cf-label-text { letter-spacing: 5px; }
  }

</style>
